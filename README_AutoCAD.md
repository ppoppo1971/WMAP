# AutoCAD에서 웹앱 사진/메모 불러오기

웹앱에서 현장 작업한 사진과 메모를 AutoCAD 도면에 자동으로 첨부하는 방법입니다.

## 📋 준비사항

### 1. 파일 다운로드
Google Drive에서 다음 파일들을 다운로드하세요:

```
📁 다운로드할 파일들
├── 도면명.dxf (원본 도면)
├── 도면명_metadata.json (사진/메모 좌표 정보)
├── 도면명_photo_20241117153045.jpg (사진1)
├── 도면명_photo_20241117153102.jpg (사진2)
└── ... (기타 사진들)
```

**중요:** 모든 파일을 **같은 폴더**에 저장하세요!

### 2. AutoLISP 스크립트
`InsertPhotos.lsp` 파일을 다운로드하여 도면과 같은 폴더에 저장하거나, AutoCAD 지원 파일 검색 경로에 저장하세요.

## 🚀 사용 방법

### 방법 1: 수동 실행 (권장)

1. **AutoCAD에서 DXF 열기**
   ```
   파일 > 열기 > 도면명.dxf 선택
   ```

2. **LISP 스크립트 로드**
   - 명령줄에 입력:
   ```
   (load "C:/경로/InsertPhotos.lsp")
   ```
   또는
   ```
   (load "InsertPhotos.lsp")
   ```
   (파일이 AutoCAD 검색 경로에 있는 경우)

3. **사진/메모 삽입 명령 실행**
   - 명령줄에 입력:
   ```
   INSERTPHOTOS
   ```

4. **완료!**
   - 스크립트가 자동으로:
     - 메타데이터 파일 읽기
     - Y축 좌표 역변환 (웹앱에서 반전된 좌표를 원래대로)
     - 사진을 정확한 위치에 삽입
     - 메모를 사진 아래에 텍스트로 삽입

### 방법 2: 자동 실행 (고급)

DXF를 열 때마다 자동으로 사진/메모를 삽입하려면:

1. **acaddoc.lsp 파일 생성**
   - 도면과 같은 폴더에 `acaddoc.lsp` 파일 생성
   - 다음 내용 입력:
   ```lisp
   (if (findfile "InsertPhotos.lsp")
     (progn
       (load "InsertPhotos.lsp")
       (princ "\n자동으로 INSERTPHOTOS 실행 중...\n")
       (C:INSERTPHOTOS)
     )
   )
   ```

2. **DXF 열기**
   - AutoCAD에서 DXF를 열면 자동으로 사진/메모가 삽입됩니다.

## 🔍 작동 원리

### 좌표 변환
웹앱(SVG)과 AutoCAD(DXF)는 Y축 방향이 반대입니다:

```
웹앱 (SVG):          AutoCAD (DXF):
  ↓ Y                  ↑ Y
  |                    |
  +--→ X               +--→ X
```

스크립트가 자동으로 변환:
```lisp
dxf-y = -svg-y
```

### 처리 흐름

1. **메타데이터 읽기**
   - `도면명_metadata.json` 파일 찾기
   - 사진/텍스트 정보 파싱

2. **사진 삽입**
   - 각 사진마다:
     - 파일 존재 확인
     - Y축 좌표 역변환
     - `IMAGEATTACH` 명령으로 삽입
     - 메모가 있으면 사진 아래 텍스트 추가

3. **독립 텍스트 삽입**
   - 사진과 별개로 작성된 메모를 `TEXT` 명령으로 삽입

## 📊 예시 출력

```
========================================
웹앱 사진/메모 자동 삽입 시작
========================================

현재 도면: 도로조사_A구간.dxf
도면 경로: C:/작업폴더/

✅ 메타데이터 발견: 도로조사_A구간_metadata.json

📊 발견된 항목:
   사진: 5개
   메모: 2개

📸 사진 삽입 시작...
   [1/5] 도로조사_A구간_photo_20241117153045.jpg
       위치: (123.45, -67.89)
       📝 메모: 균열 발견
       ✅ 삽입 완료
   [2/5] 도로조사_A구간_photo_20241117153102.jpg
       위치: (156.78, -89.12)
       ✅ 삽입 완료
   ...

📝 텍스트 삽입 시작...
   [1/2] 보수 필요
       위치: (200.00, -100.00)
       ✅ 삽입 완료
   ...

========================================
✅ 모든 항목 삽입 완료!
========================================
```

## ⚠️ 문제 해결

### "메타데이터 파일을 찾을 수 없습니다"

**원인:**
- 메타데이터 파일이 도면과 다른 폴더에 있음
- 파일명이 일치하지 않음

**해결:**
1. 파일명 확인: `도면명_metadata.json` 형식인지 확인
2. 도면과 같은 폴더에 있는지 확인
3. Google Drive에서 제대로 다운로드되었는지 확인

### "파일 없음: xxx_photo_xxx.jpg"

**원인:**
- 사진 파일이 누락됨

**해결:**
1. Google Drive에서 해당 사진 파일 다운로드
2. 도면과 같은 폴더에 저장
3. 파일명이 메타데이터의 `fileName`과 정확히 일치하는지 확인

### 이미지가 잘못된 위치에 삽입됨

**원인:**
- 웹앱에서 저장된 좌표가 잘못됨
- 좌표 변환 오류

**해결:**
1. 웹앱에서 사진을 다시 삽입하고 저장
2. 메타데이터를 다시 다운로드
3. AutoCAD에서 `UNDO` 후 스크립트 재실행

### 스크립트가 로드되지 않음

**원인:**
- LISP 파일 경로 오류
- AutoCAD에서 LISP 실행이 비활성화됨

**해결:**
1. 전체 경로로 로드: `(load "C:/경로/InsertPhotos.lsp")`
2. AutoCAD 옵션에서 LISP 실행 허용 확인:
   - `OPTIONS` → `파일` → `지원 파일 검색 경로`에 LISP 폴더 추가

## 📝 참고사항

### 이미지 스케일
- 웹앱의 `width` 값이 AutoCAD 삽입 스케일로 사용됩니다.
- 이미지가 너무 크거나 작으면 AutoCAD에서 `SCALE` 명령으로 조정하세요.

### 텍스트 높이
- 사진 메모: 사진 높이의 15%
- 독립 텍스트: 2.5 단위 (필요시 스크립트에서 수정 가능)

### 레이어
- 모든 이미지와 텍스트는 현재 레이어에 삽입됩니다.
- 별도 레이어에 삽입하려면:
  1. 스크립트 실행 전 원하는 레이어를 현재 레이어로 설정
  2. 또는 스크립트 수정하여 `(command "._LAYER" "M" "사진" "")` 추가

## 🔧 고급 설정

### 텍스트 높이 변경
스크립트 내 다음 부분 수정:
```lisp
(setq text-height (* height 0.15))  ; 사진 높이의 15% → 원하는 비율로 변경
```

```lisp
(command "._TEXT" text-pt 2.5 "0" text-content)  ; 2.5 → 원하는 크기로 변경
```

### 메모 위치 변경
스크립트 내 다음 부분 수정:
```lisp
(setq text-pt (list x (- dxf-y (* height 1.1)) 0))  ; 1.1 → 거리 조정
```

### 특정 레이어에 삽입
사진 삽입 전에 레이어 생성/활성화 추가:
```lisp
(command "._LAYER" "M" "웹앱_사진" "")  ; "웹앱_사진" 레이어 생성 및 활성화
(command "._IMAGEATTACH" photo-path insert-pt scale "" "0")
```

## 📞 지원

문제가 계속되면:
1. AutoCAD 명령줄 출력 캡처
2. 메타데이터 JSON 파일 내용 확인
3. 파일 구조 스크린샷 제공

---

**작성일:** 2024-11-17  
**버전:** 1.0  
**호환:** AutoCAD 2010 이상 (AutoLISP 지원 필요)


<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DXF ÎèÑÎ©¥ Î∑∞Ïñ¥0112</title>
    
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
            touch-action: none;
            background: #1a1a1a;
        }

        /* ÏÉÅÎã® Ìà¥Î∞î */
        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .toolbar-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .toolbar-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .toolbar-btn.secondary {
            background: #5856D6;
        }

        .toolbar-btn.danger {
            background: #FF3B30;
        }

        #filename {
            color: white;
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 10px;
        }

        /* Ï∫îÎ≤ÑÏä§ Ïª®ÌÖåÏù¥ÎÑà */
        #canvas-container {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 80px;
            background: #2a2a2a;
            overflow: hidden;
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ÌïòÎã® Ìà¥Î∞î */
        #bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 10px;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: #8E8E93;
            font-size: 11px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.2s;
        }

        .tool-btn:active {
            transform: scale(0.9);
        }

        .tool-btn.active {
            color: #007AFF;
        }

        .tool-icon {
            width: 28px;
            height: 28px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* Î™®Îã¨ Î∞∞Í≤Ω */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop.active {
            display: flex;
        }

        /* Î™®Îã¨ */
        .modal {
            background: #2C2C2E;
            border-radius: 14px;
            padding: 20px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            color: white;
        }

        .modal h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .modal input, .modal textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #48484A;
            border-radius: 8px;
            background: #1C1C1E;
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: #007AFF;
            color: white;
        }

        .modal-btn.cancel {
            background: #48484A;
            color: white;
        }

        /* Î°úÎî© Ïä§ÌîºÎÑà */
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
        }

        .spinner.active {
            display: block;
        }

        .spinner-circle {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ï£ºÏÑù ÎßàÏª§ */
        .annotation-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            cursor: pointer;
            pointer-events: auto;
            z-index: 100;
        }

        .photo-marker {
            background: #007AFF;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .text-marker {
            background: #34C759;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* ÌååÏùº ÏÑ†ÌÉù Ïà®ÍπÄ */
        input[type="file"] {
            display: none;
        }

        /* Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏å ÌååÏùº Î™©Î°ù */
        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            padding: 15px;
            border-bottom: 1px solid #48484A;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-item:active {
            background: #3A3A3C;
        }

        .file-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- ÏÉÅÎã® Ìà¥Î∞î -->
    <div id="toolbar">
        <button class="toolbar-btn" id="openBtn">Ïó¥Í∏∞</button>
        <div id="filename">ÎèÑÎ©¥ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
        <button class="toolbar-btn secondary" id="saveBtn" disabled>Ï†ÄÏû•</button>
    </div>

    <!-- Ï∫îÎ≤ÑÏä§ ÏòÅÏó≠ -->
    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <!-- ÌïòÎã® Ìà¥Î∞î -->
    <div id="bottom-toolbar">
        <button class="tool-btn" id="photoBtn" disabled>
            <div class="tool-icon">üì∑</div>
            <span>ÏÇ¨ÏßÑ</span>
        </button>
        <button class="tool-btn" id="textBtn" disabled>
            <div class="tool-icon">üìù</div>
            <span>ÌÖçÏä§Ìä∏</span>
        </button>
        <button class="tool-btn" id="fitBtn" disabled>
            <div class="tool-icon">‚ä°</div>
            <span>Ï†ÑÏ≤¥Î≥¥Í∏∞</span>
        </button>
    </div>

    <!-- ÌååÏùº ÏÑ†ÌÉù Î™®Îã¨ -->
    <div class="modal-backdrop" id="fileModal">
        <div class="modal">
            <h3>DXF ÌååÏùº ÏÑ†ÌÉù</h3>
            <div class="file-list" id="fileList"></div>
            <div class="modal-buttons" style="margin-top: 15px;">
                <button class="modal-btn cancel" id="closeFileModal">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <!-- ÌÖçÏä§Ìä∏ ÏûÖÎ†• Î™®Îã¨ -->
    <div class="modal-backdrop" id="textModal">
        <div class="modal">
            <h3>ÌÖçÏä§Ìä∏ ÏûÖÎ†•</h3>
            <textarea id="textInput" rows="4" placeholder="ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancelText">Ï∑®ÏÜå</button>
                <button class="modal-btn primary" id="confirmText">Ï∂îÍ∞Ä</button>
            </div>
        </div>
    </div>

    <!-- Î°úÎî© Ïä§ÌîºÎÑà -->
    <div class="spinner" id="spinner">
        <div class="spinner-circle"></div>
    </div>

    <!-- Ïà®ÍπÄ ÌååÏùº ÏûÖÎ†• -->
    <input type="file" id="photoInput" accept="image/*" capture="environment">
    <input type="file" id="galleryInput" accept="image/*">

    <!-- Three.js ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- DXF ÌååÏÑú ÎùºÏù¥Î∏åÎü¨Î¶¨ - unpkg CDN ÏÇ¨Ïö© (Îçî ÏïàÏ†ïÏ†Å) -->
    <script src="https://unpkg.com/dxf-parser@1.3.0/dist/dxf-parser.min.js"></script>
    <script src="https://unpkg.com/three-dxf@3.2.2/dist/three-dxf.min.js"></script>

    <script>
        // ========================================
        // Ï†ÑÏó≠ Î≥ÄÏàò Î∞è Ï¥àÍ∏∞Ìôî
        // ========================================
        
        // DXF ÌååÏùº Î™©Î°ù ÏÑ§Ï†ï (GitHub raw URL ÏÇ¨Ïö©)
        const DXF_FILES = [
            { 
                name: 'test02.dxf', 
                path: 'https://raw.githubusercontent.com/ppoppo1971/DMAP/main/test02.dxf' 
            }
            // Ï∂îÍ∞Ä ÌååÏùºÏù¥ ÏûàÏúºÎ©¥ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî
            // { name: 'ÌååÏùºÎ™Ö.dxf', path: 'https://raw.githubusercontent.com/ÏÇ¨Ïö©ÏûêÎ™Ö/Ï†ÄÏû•ÏÜåÎ™Ö/main/ÌååÏùºÎ™Ö.dxf' }
        ];

        let scene, camera, renderer, controls;
        let dxfData = null; // DXF Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        let currentFilePath = null; // ÌòÑÏû¨ Ïó¥Î¶∞ ÌååÏùº Í≤ΩÎ°ú
        let currentFileName = null; // ÌòÑÏû¨ ÌååÏùº Ïù¥Î¶Ñ
        let annotations = []; // Ï£ºÏÑù Î∞∞Ïó¥ (ÏÇ¨ÏßÑ, ÌÖçÏä§Ìä∏)
        
        // ÌÑ∞Ïπò Í¥ÄÎ†® Î≥ÄÏàò
        let isDragging = false;
        let previousTouch = null;
        let isPinching = false;
        let lastPinchDistance = 0;
        let longPressTimer = null;
        let longPressPosition = null;

        // ========================================
        // Three.js Ï¥àÍ∏∞Ìôî
        // ========================================
        
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const canvas = document.getElementById('canvas');
            
            // Scene ÏÉùÏÑ±
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2a2a2a);
            
            // Camera ÏÉùÏÑ± (OrthographicCamera - 2D ÎèÑÎ©¥Ïö©)
            const aspect = container.clientWidth / container.clientHeight;
            const viewSize = 100;
            camera = new THREE.OrthographicCamera(
                -viewSize * aspect, viewSize * aspect,
                viewSize, -viewSize,
                0.1, 1000
            );
            camera.position.z = 100;
            camera.lookAt(0, 0, 0);
            
            // Renderer ÏÉùÏÑ±
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true 
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // Ï°∞Î™Ö Ï∂îÍ∞Ä
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 0, 100);
            scene.add(directionalLight);
            
            // Î†åÎçîÎßÅ ÏãúÏûë
            animate();
            
            // Î¶¨ÏÇ¨Ïù¥Ï¶à Ï≤òÎ¶¨
            window.addEventListener('resize', onWindowResize);
        }

        // ========================================
        // Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ
        // ========================================
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // ========================================
        // ÏúàÎèÑÏö∞ Î¶¨ÏÇ¨Ïù¥Ï¶à Ï≤òÎ¶¨
        // ========================================
        
        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const aspect = container.clientWidth / container.clientHeight;
            
            const viewSize = 100;
            camera.left = -viewSize * aspect;
            camera.right = viewSize * aspect;
            camera.top = viewSize;
            camera.bottom = -viewSize;
            
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // ========================================
        // DXF ÌååÏùº Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
        // ========================================
        
        function listDXFFiles() {
            // DXF_FILES Î∞∞Ïó¥ÏóêÏÑú ÌååÏùº Î™©Î°ù Î∞òÌôò
            return DXF_FILES;
        }

        // ========================================
        // DXF ÌååÏùº Îã§Ïö¥Î°úÎìú (fetch ÏÇ¨Ïö©)
        // ========================================
        
        async function downloadDXFFile(filePath) {
            try {
                console.log('DXF ÌååÏùº Î°úÎìú Ï§ë:', filePath);
                
                const response = await fetch(filePath);
                
                if (!response.ok) {
                    throw new Error(`ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ${filePath} (${response.status})`);
                }
                
                const dxfString = await response.text();
                console.log('DXF ÌååÏùº Î°úÎìú ÏôÑÎ£å');
                
                return dxfString;
            } catch (error) {
                console.error('ÌååÏùº Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', error);
                throw error;
            }
        }

        function parseDXF(dxfString) {
            try {
                // dxf-parser ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º ÏÇ¨Ïö©ÌïòÏó¨ ÌååÏã±
                console.log('DXF ÌååÏã± ÏãúÏûë...');
                console.log('DxfParser ÏÇ¨Ïö© Í∞ÄÎä•:', typeof DxfParser);
                
                const parser = new DxfParser();
                const dxf = parser.parseSync(dxfString);
                
                console.log('DXF ÌååÏã± ÏôÑÎ£å:', dxf);
                return dxf;
            } catch (error) {
                console.error('DXF ÌååÏã± Ïã§Ìå®:', error);
                throw error;
            }
        }

        function renderDXF(dxf) {
            try {
                console.log('DXF Î†åÎçîÎßÅ ÏãúÏûë...');
                console.log('ThreeDxf ÏÇ¨Ïö© Í∞ÄÎä•:', typeof window.ThreeDxf);
                
                // Í∏∞Ï°¥ DXF Í∞ùÏ≤¥ Ï†úÍ±∞
                scene.children = scene.children.filter(child => 
                    child instanceof THREE.Light || child.userData.type === 'annotation'
                );
                
                // DXF Îç∞Ïù¥ÌÑ∞Î•º Three.js Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                const helper = new window.ThreeDxf.Helper(dxf);
                const entity = helper.toObject();
                
                console.log('DXF Í∞ùÏ≤¥ ÏÉùÏÑ± ÏôÑÎ£å:', entity);
                
                scene.add(entity);
                
                // Ï†ÑÏ≤¥ Î≥¥Í∏∞Î°ú Ïπ¥Î©îÎùº Ï°∞Ï†ï
                fitToView();
                
                console.log('DXF Î†åÎçîÎßÅ ÏôÑÎ£å');
            } catch (error) {
                console.error('DXF Î†åÎçîÎßÅ Ïã§Ìå®:', error);
                alert(`ÎèÑÎ©¥ Î†åÎçîÎßÅÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}`);
                throw error;
            }
        }

        // ========================================
        // Ï†ÑÏ≤¥ Î≥¥Í∏∞ (Fit to View)
        // ========================================
        
        function fitToView() {
            // SceneÏùò Î∞îÏö¥Îî© Î∞ïÏä§ Í≥ÑÏÇ∞
            const box = new THREE.Box3();
            
            scene.children.forEach(child => {
                if (!(child instanceof THREE.Light)) {
                    box.expandByObject(child);
                }
            });
            
            if (box.isEmpty()) return;
            
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            
            // Ïπ¥Î©îÎùº ÏúÑÏπò Ï°∞Ï†ï
            const container = document.getElementById('canvas-container');
            const aspect = container.clientWidth / container.clientHeight;
            
            const maxSize = Math.max(size.x / aspect, size.y);
            const viewSize = maxSize / 2 * 1.1; // 10% Ïó¨Î∞±
            
            camera.left = -viewSize * aspect;
            camera.right = viewSize * aspect;
            camera.top = viewSize;
            camera.bottom = -viewSize;
            
            camera.position.x = center.x;
            camera.position.y = center.y;
            camera.position.z = 100;
            
            camera.updateProjectionMatrix();
        }

        // ========================================
        // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
        // ========================================
        
        function setupTouchControls() {
            const canvas = document.getElementById('canvas');
            
            // ÌÑ∞Ïπò ÏãúÏûë
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                
                if (e.touches.length === 1) {
                    // Îã®Ïùº ÌÑ∞Ïπò - Î°±ÌîÑÎ†àÏä§ Í∞êÏßÄ ÏãúÏûë
                    const touch = e.touches[0];
                    longPressPosition = { x: touch.clientX, y: touch.clientY };
                    
                    longPressTimer = setTimeout(() => {
                        handleLongPress(longPressPosition);
                    }, 800); // 800ms Î°±ÌîÑÎ†àÏä§
                    
                    previousTouch = { x: touch.clientX, y: touch.clientY };
                    
                } else if (e.touches.length === 2) {
                    // ÌïÄÏπò Ï§å ÏãúÏûë
                    clearTimeout(longPressTimer);
                    isPinching = true;
                    
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    
                    const dx = touch2.clientX - touch1.clientX;
                    const dy = touch2.clientY - touch1.clientY;
                    lastPinchDistance = Math.sqrt(dx * dx + dy * dy);
                }
            });
            
            // ÌÑ∞Ïπò Ïù¥Îèô
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                // Ïù¥ÎèôÌïòÎ©¥ Î°±ÌîÑÎ†àÏä§ Ï∑®ÏÜå
                if (longPressTimer) {
                    const touch = e.touches[0];
                    const dx = touch.clientX - longPressPosition.x;
                    const dy = touch.clientY - longPressPosition.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 10) { // 10px Ïù¥ÏÉÅ Ïù¥ÎèôÌïòÎ©¥ Ï∑®ÏÜå
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                }
                
                if (e.touches.length === 1 && previousTouch && !isPinching) {
                    // Ìå®Îãù
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - previousTouch.x;
                    const deltaY = touch.clientY - previousTouch.y;
                    
                    panCamera(deltaX, deltaY);
                    
                    previousTouch = { x: touch.clientX, y: touch.clientY };
                    
                } else if (e.touches.length === 2 && isPinching) {
                    // ÌïÄÏπò Ï§å
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    
                    const dx = touch2.clientX - touch1.clientX;
                    const dy = touch2.clientY - touch1.clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    const delta = distance - lastPinchDistance;
                    zoomCamera(delta * 0.01);
                    
                    lastPinchDistance = distance;
                }
            });
            
            // ÌÑ∞Ïπò Ï¢ÖÎ£å
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                if (e.touches.length === 0) {
                    isDragging = false;
                    isPinching = false;
                    previousTouch = null;
                } else if (e.touches.length === 1) {
                    isPinching = false;
                    previousTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });
        }

        // ========================================
        // Ïπ¥Î©îÎùº Ïù¥Îèô (Pan)
        // ========================================
        
        function panCamera(deltaX, deltaY) {
            const container = document.getElementById('canvas-container');
            const aspect = container.clientWidth / container.clientHeight;
            
            const viewWidth = (camera.right - camera.left);
            const viewHeight = (camera.top - camera.bottom);
            
            const moveX = -(deltaX / container.clientWidth) * viewWidth;
            const moveY = (deltaY / container.clientHeight) * viewHeight;
            
            camera.position.x += moveX;
            camera.position.y += moveY;
        }

        // ========================================
        // Ïπ¥Î©îÎùº Ï§å
        // ========================================
        
        function zoomCamera(delta) {
            const container = document.getElementById('canvas-container');
            const aspect = container.clientWidth / container.clientHeight;
            
            const zoomFactor = 1 - delta;
            
            const viewWidth = (camera.right - camera.left) * zoomFactor;
            const viewHeight = (camera.top - camera.bottom) * zoomFactor;
            
            camera.left = -viewWidth / 2;
            camera.right = viewWidth / 2;
            camera.top = viewHeight / 2;
            camera.bottom = -viewHeight / 2;
            
            camera.updateProjectionMatrix();
        }

        // ========================================
        // Î°±ÌîÑÎ†àÏä§ Ï≤òÎ¶¨
        // ========================================
        
        function handleLongPress(position) {
            if (!dxfData) return;
            
            // ÌÑ∞Ïπò ÏúÑÏπòÎ•º 3D Ï¢åÌëúÎ°ú Î≥ÄÌôò
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            
            const x = ((position.x - rect.left) / rect.width) * 2 - 1;
            const y = -((position.y - rect.top) / rect.height) * 2 + 1;
            
            // Ïπ¥Î©îÎùº Ï¢åÌëúÍ≥ÑÎ°ú Î≥ÄÌôò
            const worldX = camera.position.x + x * (camera.right - camera.left) / 2;
            const worldY = camera.position.y + y * (camera.top - camera.bottom) / 2;
            
            // ÏÇ¨ÏßÑ/ÌÖçÏä§Ìä∏ ÏÑ†ÌÉù Î©îÎâ¥ ÌëúÏãú
            showAnnotationMenu(worldX, worldY);
        }

        // ========================================
        // Ï£ºÏÑù Ï∂îÍ∞Ä Î©îÎâ¥
        // ========================================
        
        let pendingAnnotationPosition = null;

        function showAnnotationMenu(x, y) {
            pendingAnnotationPosition = { x, y };
            
            const choice = confirm('ÏÇ¨ÏßÑÏùÑ Ï∂îÍ∞ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÌôïÏù∏: ÏÇ¨ÏßÑ\nÏ∑®ÏÜå: ÌÖçÏä§Ìä∏');
            
            if (choice) {
                showPhotoOptions();
            } else {
                showTextModal();
            }
        }

        function showPhotoOptions() {
            const choice = confirm('Ïπ¥Î©îÎùºÎ°ú Ï¥¨ÏòÅÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÌôïÏù∏: Ïπ¥Î©îÎùº\nÏ∑®ÏÜå: Í∞§Îü¨Î¶¨');
            
            if (choice) {
                document.getElementById('photoInput').click();
            } else {
                document.getElementById('galleryInput').click();
            }
        }

        // ========================================
        // ÏÇ¨ÏßÑ Ï≤òÎ¶¨
        // ========================================
        
        function setupPhotoInput() {
            const photoInput = document.getElementById('photoInput');
            const galleryInput = document.getElementById('galleryInput');
            
            photoInput.addEventListener('change', handlePhotoSelect);
            galleryInput.addEventListener('change', handlePhotoSelect);
        }

        async function handlePhotoSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                const imageData = event.target.result; // Base64 Îç∞Ïù¥ÌÑ∞
                
                if (pendingAnnotationPosition) {
                    // Ï£ºÏÑù Ï∂îÍ∞Ä (Ïù¥ÎØ∏ÏßÄÎ•º Base64Î°ú Ï†ÄÏû•)
                    const annotation = {
                        type: 'photo',
                        position: pendingAnnotationPosition,
                        imageData: imageData, // Base64 ÌòïÏãùÏúºÎ°ú Ï†ÄÏû•
                        imageName: file.name,
                        timestamp: new Date().toISOString()
                    };
                    
                    annotations.push(annotation);
                    updateAnnotationMarkers();
                    
                    // ÏûêÎèô Ï†ÄÏû• (localStorage)
                    saveAnnotations();
                    
                    pendingAnnotationPosition = null;
                }
            };
            reader.readAsDataURL(file);
            
            // ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
            e.target.value = '';
        }

        // ========================================
        // ÌÖçÏä§Ìä∏ Î™®Îã¨
        // ========================================
        
        function showTextModal() {
            document.getElementById('textModal').classList.add('active');
            document.getElementById('textInput').value = '';
            document.getElementById('textInput').focus();
        }

        function setupTextModal() {
            const textModal = document.getElementById('textModal');
            const textInput = document.getElementById('textInput');
            const confirmBtn = document.getElementById('confirmText');
            const cancelBtn = document.getElementById('cancelText');
            
            confirmBtn.addEventListener('click', () => {
                const text = textInput.value.trim();
                if (text && pendingAnnotationPosition) {
                    const annotation = {
                        type: 'text',
                        position: pendingAnnotationPosition,
                        text: text,
                        timestamp: new Date().toISOString()
                    };
                    
                    annotations.push(annotation);
                    updateAnnotationMarkers();
                    
                    // ÏûêÎèô Ï†ÄÏû• (localStorage)
                    saveAnnotations();
                    
                    pendingAnnotationPosition = null;
                }
                
                textModal.classList.remove('active');
            });
            
            cancelBtn.addEventListener('click', () => {
                textModal.classList.remove('active');
                pendingAnnotationPosition = null;
            });
        }

        // ========================================
        // Ï£ºÏÑù ÎßàÏª§ ÏóÖÎç∞Ïù¥Ìä∏
        // ========================================
        
        function updateAnnotationMarkers() {
            // Í∏∞Ï°¥ ÎßàÏª§ Ï†úÍ±∞
            document.querySelectorAll('.annotation-marker').forEach(el => el.remove());
            
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            
            annotations.forEach((annotation, index) => {
                // 3D Ï¢åÌëúÎ•º ÌôîÎ©¥ Ï¢åÌëúÎ°ú Î≥ÄÌôò
                const screenPos = worldToScreen(annotation.position.x, annotation.position.y);
                
                const marker = document.createElement('div');
                marker.className = `annotation-marker ${annotation.type}-marker`;
                marker.innerHTML = annotation.type === 'photo' ? 'üì∑' : 'üìù';
                marker.style.left = `${screenPos.x - 15}px`;
                marker.style.top = `${screenPos.y - 15}px`;
                marker.dataset.index = index;
                
                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ - Ï£ºÏÑù Î≥¥Í∏∞
                marker.addEventListener('click', () => {
                    showAnnotationDetail(annotation);
                });
                
                container.appendChild(marker);
            });
        }

        // ========================================
        // 3D Ï¢åÌëúÎ•º ÌôîÎ©¥ Ï¢åÌëúÎ°ú Î≥ÄÌôò
        // ========================================
        
        function worldToScreen(worldX, worldY) {
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            
            const viewWidth = camera.right - camera.left;
            const viewHeight = camera.top - camera.bottom;
            
            const normalizedX = (worldX - camera.position.x) / (viewWidth / 2);
            const normalizedY = (worldY - camera.position.y) / (viewHeight / 2);
            
            const screenX = (normalizedX + 1) / 2 * rect.width;
            const screenY = (1 - normalizedY) / 2 * rect.height;
            
            return { x: screenX, y: screenY };
        }

        // ========================================
        // Ï£ºÏÑù ÏÉÅÏÑ∏Î≥¥Í∏∞
        // ========================================
        
        function showAnnotationDetail(annotation) {
            if (annotation.type === 'photo') {
                // Ïù¥ÎØ∏ÏßÄÎ•º ÏÉà Ï∞ΩÏóê ÌëúÏãú
                const imageWindow = window.open('', '_blank');
                imageWindow.document.write(`
                    <html>
                    <head>
                        <title>${annotation.imageName}</title>
                        <style>
                            body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
                            img { max-width: 100%; max-height: 100vh; object-fit: contain; }
                        </style>
                    </head>
                    <body>
                        <img src="${annotation.imageData}" alt="${annotation.imageName}">
                        <p style="color: white; position: fixed; top: 10px; left: 10px;">
                            ${annotation.imageName}<br>
                            ${new Date(annotation.timestamp).toLocaleString('ko-KR')}
                        </p>
                    </body>
                    </html>
                `);
            } else {
                alert(`ÌÖçÏä§Ìä∏: ${annotation.text}\nÎÇ†Ïßú: ${new Date(annotation.timestamp).toLocaleString('ko-KR')}`);
            }
        }

        // ========================================
        // Ï£ºÏÑù Ï†ÄÏû• (localStorage ÏÇ¨Ïö©)
        // ========================================
        
        function saveAnnotations() {
            if (!currentFileName || annotations.length === 0) {
                console.log('Ï†ÄÏû•Ìï† Ï£ºÏÑùÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            try {
                const storageKey = `annotations_${currentFileName}`;
                const data = {
                    fileName: currentFileName,
                    filePath: currentFilePath,
                    annotations: annotations,
                    savedAt: new Date().toISOString()
                };
                
                localStorage.setItem(storageKey, JSON.stringify(data));
                console.log('Ï£ºÏÑù Ï†ÄÏû• ÏôÑÎ£å:', annotations.length);
            } catch (error) {
                console.error('Ï£ºÏÑù Ï†ÄÏû• Ïã§Ìå®:', error);
                
                // localStorage Ïö©Îüâ Ï¥àÍ≥º Ïãú
                if (error.name === 'QuotaExceededError') {
                    alert('Ï†ÄÏû• Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.\nÏù¥Ï†Ñ Ï£ºÏÑùÏùÑ ÏÇ≠Ï†úÌï¥Ï£ºÏÑ∏Ïöî.');
                } else {
                    alert('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            }
        }

        // ========================================
        // Í∏∞Ï°¥ Ï£ºÏÑù Î°úÎìú (localStorageÏóêÏÑú)
        // ========================================
        
        function loadAnnotations() {
            if (!currentFileName) return;
            
            try {
                const storageKey = `annotations_${currentFileName}`;
                const savedData = localStorage.getItem(storageKey);
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    annotations = data.annotations || [];
                    
                    updateAnnotationMarkers();
                    console.log('Ï£ºÏÑù Î°úÎìú ÏôÑÎ£å:', annotations.length);
                } else {
                    console.log('Ï†ÄÏû•Îêú Ï£ºÏÑùÏù¥ ÏóÜÏäµÎãàÎã§.');
                    annotations = [];
                }
            } catch (error) {
                console.error('Ï£ºÏÑù Î°úÎìú Ïã§Ìå®:', error);
                annotations = [];
            }
        }

        // ========================================
        // ÌååÏùº Ïó¥Í∏∞ Î≤ÑÌäº
        // ========================================
        
        function openFile() {
            // ÌååÏùº Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
            const files = listDXFFiles();
            
            if (files.length === 0) {
                alert('DXF_FILES Î∞∞Ïó¥Ïóê ÌååÏùºÏù¥ Ï†ïÏùòÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.\nÏΩîÎìúÏóêÏÑú DXF ÌååÏùº Í≤ΩÎ°úÎ•º Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // ÌååÏùº ÏÑ†ÌÉù Î™®Îã¨ ÌëúÏãú
            showFileModal(files);
        }

        function showFileModal(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.textContent = file.name;
                item.addEventListener('click', () => {
                    loadDXFFile(file.path, file.name);
                    document.getElementById('fileModal').classList.remove('active');
                });
                fileList.appendChild(item);
            });
            
            document.getElementById('fileModal').classList.add('active');
        }

        // ========================================
        // DXF ÌååÏùº Î°úÎìú Î∞è Î†åÎçîÎßÅ
        // ========================================
        
        async function loadDXFFile(filePath, fileName) {
            showSpinner(true);
            
            try {
                // DXF ÌååÏùº Îã§Ïö¥Î°úÎìú (fetch ÏÇ¨Ïö©)
                const dxfString = await downloadDXFFile(filePath);
                
                // DXF ÌååÏã±
                dxfData = parseDXF(dxfString);
                
                // Î†åÎçîÎßÅ
                renderDXF(dxfData);
                
                // ÌòÑÏû¨ ÌååÏùº Ï†ïÎ≥¥ Ï†ÄÏû•
                currentFilePath = filePath;
                currentFileName = fileName.replace('.dxf', '');
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('filename').textContent = fileName;
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('photoBtn').disabled = false;
                document.getElementById('textBtn').disabled = false;
                document.getElementById('fitBtn').disabled = false;
                
                // Í∏∞Ï°¥ Ï£ºÏÑù Î°úÎìú (localStorageÏóêÏÑú)
                annotations = [];
                loadAnnotations();
                
            } catch (error) {
                console.error('ÌååÏùº Î°úÎìú Ïã§Ìå®:', error);
                alert(`ÌååÏùºÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏò§Î•ò: ${error.message}`);
            } finally {
                showSpinner(false);
            }
        }

        // ========================================
        // Ïä§ÌîºÎÑà ÌëúÏãú/Ïà®ÍπÄ
        // ========================================
        
        function showSpinner(show) {
            const spinner = document.getElementById('spinner');
            if (show) {
                spinner.classList.add('active');
            } else {
                spinner.classList.remove('active');
            }
        }

        // ========================================
        // Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        // ========================================
        
        function setupButtonListeners() {
            // Ïó¥Í∏∞ Î≤ÑÌäº
            document.getElementById('openBtn').addEventListener('click', openFile);
            
            // Ï†ÄÏû• Î≤ÑÌäº
            document.getElementById('saveBtn').addEventListener('click', () => {
                saveAnnotations();
                alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
            });
            
            // ÏÇ¨ÏßÑ Î≤ÑÌäº (Ìà¥Î∞î)
            document.getElementById('photoBtn').addEventListener('click', () => {
                alert('ÎèÑÎ©¥ÏùÑ Í∏∏Í≤å ÎàÑÎ•¥Í≥† ÏûàÏúºÎ©¥ ÏÇ¨ÏßÑÏù¥ÎÇò ÌÖçÏä§Ìä∏Î•º Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.');
            });
            
            // ÌÖçÏä§Ìä∏ Î≤ÑÌäº (Ìà¥Î∞î)
            document.getElementById('textBtn').addEventListener('click', () => {
                alert('ÎèÑÎ©¥ÏùÑ Í∏∏Í≤å ÎàÑÎ•¥Í≥† ÏûàÏúºÎ©¥ ÏÇ¨ÏßÑÏù¥ÎÇò ÌÖçÏä§Ìä∏Î•º Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.');
            });
            
            // Ï†ÑÏ≤¥Î≥¥Í∏∞ Î≤ÑÌäº
            document.getElementById('fitBtn').addEventListener('click', fitToView);
            
            // ÌååÏùº Î™®Îã¨ Îã´Í∏∞
            document.getElementById('closeFileModal').addEventListener('click', () => {
                document.getElementById('fileModal').classList.remove('active');
            });
        }

        // ========================================
        // Ï¥àÍ∏∞Ìôî Î∞è ÏãúÏûë
        // ========================================
        
        function init() {
            console.log('Ïï± Ï¥àÍ∏∞Ìôî ÏãúÏûë...');
            
            try {
                // ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÌôïÏù∏
                console.log('THREE Î°úÎìú ÏÉÅÌÉú:', typeof THREE);
                console.log('DxfParser Î°úÎìú ÏÉÅÌÉú:', typeof DxfParser);
                console.log('ThreeDxf Î°úÎìú ÏÉÅÌÉú:', typeof window.ThreeDxf);
                
                if (typeof DxfParser === 'undefined') {
                    throw new Error('DxfParser ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }
                
                if (typeof window.ThreeDxf === 'undefined') {
                    throw new Error('ThreeDxf ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                }
                
                // Three.js Ï¥àÍ∏∞Ìôî
                initThreeJS();
                
                // ÌÑ∞Ïπò Ïª®Ìä∏Î°§ ÏÑ§Ï†ï
                setupTouchControls();
                
                // Î≤ÑÌäº Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                setupButtonListeners();
                
                // ÏÇ¨ÏßÑ ÏûÖÎ†• ÏÑ§Ï†ï
                setupPhotoInput();
                
                // ÌÖçÏä§Ìä∏ Î™®Îã¨ ÏÑ§Ï†ï
                setupTextModal();
                
                console.log('Ïï± Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ‚úì');
                
            } catch (error) {
                console.error('Ïï± Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                alert(`Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\n${error.message}\n\nÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.`);
            }
        }

        // Ïï± ÏãúÏûë - Î™®Îì† Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Î°úÎìúÎêú ÌõÑ Ïã§Ìñâ
        function waitForLibraries() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 10Ï¥à ÎåÄÍ∏∞
                
                const checkLibraries = setInterval(() => {
                    attempts++;
                    
                    console.log(`ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú Ï≤¥ÌÅ¨ Ï§ë... (${attempts}/${maxAttempts})`);
                    console.log('- THREE:', typeof THREE);
                    console.log('- DxfParser:', typeof DxfParser);
                    console.log('- ThreeDxf:', typeof window.ThreeDxf);
                    
                    if (typeof THREE !== 'undefined' && 
                        typeof DxfParser !== 'undefined' && 
                        typeof window.ThreeDxf !== 'undefined') {
                        clearInterval(checkLibraries);
                        console.log('‚úÖ Î™®Îì† ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÏôÑÎ£å!');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkLibraries);
                        reject(new Error('ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÌÉÄÏûÑÏïÑÏõÉ'));
                    }
                }, 200); // 200msÎßàÎã§ Ï≤¥ÌÅ¨
            });
        }

        window.addEventListener('load', async () => {
            try {
                console.log('ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å. ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎåÄÍ∏∞ Ï§ë...');
                await waitForLibraries();
                init();
            } catch (error) {
                console.error('ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú Ïã§Ìå®:', error);
                alert('ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.\nÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        });

        // Ïπ¥Î©îÎùº Ïù¥ÎèôÏãú ÎßàÏª§ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
        setInterval(() => {
            if (annotations.length > 0 && dxfData) {
                updateAnnotationMarkers();
            }
        }, 100); // 100msÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
    </script>
</body>
</html>

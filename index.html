<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DXF ÎèÑÎ©¥ Î∑∞Ïñ¥1140</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
            touch-action: none;
            background: #1a1a1a;
        }

        /* ÏÉÅÎã® Ìà¥Î∞î */
        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .toolbar-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .toolbar-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        .toolbar-btn.secondary {
            background: #5856D6;
        }

        .toolbar-btn.danger {
            background: #FF3B30;
        }

        #filename {
            color: white;
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 10px;
        }

        /* Ï∫îÎ≤ÑÏä§ Ïª®ÌÖåÏù¥ÎÑà */
        #canvas-container {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 80px;
            background: #2a2a2a;
            overflow: hidden;
        }

        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ÌïòÎã® Ìà¥Î∞î */
        #bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 10px;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: #8E8E93;
            font-size: 11px;
            cursor: pointer;
            padding: 5px;
            transition: all 0.2s;
        }

        .tool-btn:active {
            transform: scale(0.9);
        }

        .tool-btn.active {
            color: #007AFF;
        }

        .tool-icon {
            width: 28px;
            height: 28px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        /* Î™®Îã¨ Î∞∞Í≤Ω */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop.active {
            display: flex;
        }

        /* Î™®Îã¨ */
        .modal {
            background: #2C2C2E;
            border-radius: 14px;
            padding: 20px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            color: white;
        }

        .modal h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .modal input, .modal textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #48484A;
            border-radius: 8px;
            background: #1C1C1E;
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: #007AFF;
            color: white;
        }

        .modal-btn.cancel {
            background: #48484A;
            color: white;
        }

        /* Î°úÎî© Ïä§ÌîºÎÑà */
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
        }

        .spinner.active {
            display: block;
        }

        .spinner-circle {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ï£ºÏÑù ÎßàÏª§ */
        .annotation-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            cursor: pointer;
            pointer-events: auto;
            z-index: 100;
        }

        .photo-marker {
            background: #007AFF;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .text-marker {
            background: #34C759;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* ÌååÏùº ÏÑ†ÌÉù Ïà®ÍπÄ */
        input[type="file"] {
            display: none;
        }

        /* Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏å ÌååÏùº Î™©Î°ù */
        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            padding: 15px;
            border-bottom: 1px solid #48484A;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-item:active {
            background: #3A3A3C;
        }

        .file-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- ÏÉÅÎã® Ìà¥Î∞î -->
    <div id="toolbar">
        <button class="toolbar-btn" id="openBtn">Ïó¥Í∏∞</button>
        <div id="filename">ÎèÑÎ©¥ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
        <button class="toolbar-btn secondary" id="saveBtn" disabled>Ï†ÄÏû•</button>
    </div>

    <!-- Ï∫îÎ≤ÑÏä§ ÏòÅÏó≠ -->
    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <!-- ÌïòÎã® Ìà¥Î∞î -->
    <div id="bottom-toolbar">
        <button class="tool-btn" id="photoBtn" disabled>
            <div class="tool-icon">üì∑</div>
            <span>ÏÇ¨ÏßÑ</span>
        </button>
        <button class="tool-btn" id="textBtn" disabled>
            <div class="tool-icon">üìù</div>
            <span>ÌÖçÏä§Ìä∏</span>
        </button>
        <button class="tool-btn" id="fitBtn" disabled>
            <div class="tool-icon">‚ä°</div>
            <span>Ï†ÑÏ≤¥Î≥¥Í∏∞</span>
        </button>
    </div>

    <!-- ÌååÏùº ÏÑ†ÌÉù Î™®Îã¨ -->
    <div class="modal-backdrop" id="fileModal">
        <div class="modal">
            <h3>Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏åÏóêÏÑú ÏÑ†ÌÉù</h3>
            <div class="file-list" id="fileList"></div>
            <div class="modal-buttons" style="margin-top: 15px;">
                <button class="modal-btn cancel" id="closeFileModal">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <!-- ÌÖçÏä§Ìä∏ ÏûÖÎ†• Î™®Îã¨ -->
    <div class="modal-backdrop" id="textModal">
        <div class="modal">
            <h3>ÌÖçÏä§Ìä∏ ÏûÖÎ†•</h3>
            <textarea id="textInput" rows="4" placeholder="ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancelText">Ï∑®ÏÜå</button>
                <button class="modal-btn primary" id="confirmText">Ï∂îÍ∞Ä</button>
            </div>
        </div>
    </div>

    <!-- Î°úÎî© Ïä§ÌîºÎÑà -->
    <div class="spinner" id="spinner">
        <div class="spinner-circle"></div>
    </div>

    <!-- Ïà®ÍπÄ ÌååÏùº ÏûÖÎ†• -->
    <input type="file" id="photoInput" accept="image/*" capture="environment">
    <input type="file" id="galleryInput" accept="image/*">

    <!-- Three.js ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three-dxf@3.2.2/dist/three-dxf.min.js"></script>

    <script>
        // ========================================
        // Ï†ÑÏó≠ Î≥ÄÏàò Î∞è Ï¥àÍ∏∞Ìôî
        // ========================================
        
        const CLIENT_ID = '906332453523-or8l93395kamm6sipv4hogn93i2clj3k.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAMBSJ39taPtfZgkIocKzIx3rutrCcaMaI';
        const FOLDER_ID = '18NRsrVaR2OUiU4mf5zMseoFM-fij0FWX';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let scene, camera, renderer, controls;
        let dxfData = null; // DXF Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        let currentFileId = null; // ÌòÑÏû¨ Ïó¥Î¶∞ ÌååÏùº ID
        let currentFileName = null; // ÌòÑÏû¨ ÌååÏùº Ïù¥Î¶Ñ
        let annotations = []; // Ï£ºÏÑù Î∞∞Ïó¥ (ÏÇ¨ÏßÑ, ÌÖçÏä§Ìä∏)
        let accessToken = null; // Íµ¨Í∏Ä Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞
        
        // ÌÑ∞Ïπò Í¥ÄÎ†® Î≥ÄÏàò
        let isDragging = false;
        let previousTouch = null;
        let isPinching = false;
        let lastPinchDistance = 0;
        let longPressTimer = null;
        let longPressPosition = null;

        // ========================================
        // Three.js Ï¥àÍ∏∞Ìôî
        // ========================================
        
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const canvas = document.getElementById('canvas');
            
            // Scene ÏÉùÏÑ±
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2a2a2a);
            
            // Camera ÏÉùÏÑ± (OrthographicCamera - 2D ÎèÑÎ©¥Ïö©)
            const aspect = container.clientWidth / container.clientHeight;
            const viewSize = 100;
            camera = new THREE.OrthographicCamera(
                -viewSize * aspect, viewSize * aspect,
                viewSize, -viewSize,
                0.1, 1000
            );
            camera.position.z = 100;
            camera.lookAt(0, 0, 0);
            
            // Renderer ÏÉùÏÑ±
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true 
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // Ï°∞Î™Ö Ï∂îÍ∞Ä
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 0, 100);
            scene.add(directionalLight);
            
            // Î†åÎçîÎßÅ ÏãúÏûë
            animate();
            
            // Î¶¨ÏÇ¨Ïù¥Ï¶à Ï≤òÎ¶¨
            window.addEventListener('resize', onWindowResize);
        }

        // ========================================
        // Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ
        // ========================================
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // ========================================
        // ÏúàÎèÑÏö∞ Î¶¨ÏÇ¨Ïù¥Ï¶à Ï≤òÎ¶¨
        // ========================================
        
        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const aspect = container.clientWidth / container.clientHeight;
            
            const viewSize = 100;
            camera.left = -viewSize * aspect;
            camera.right = viewSize * aspect;
            camera.top = viewSize;
            camera.bottom = -viewSize;
            
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // ========================================
        // Íµ¨Í∏Ä OAuth Ïù∏Ï¶ù
        // ========================================
        
        async function initGoogleAPI() {
            return new Promise((resolve, reject) => {
                console.log('Google API Î°úÎìú ÏãúÏûë...');
                gapi.load('client:auth2', async () => {
                    try {
                        console.log('Google API Ï¥àÍ∏∞Ìôî Ï§ë...');
                        console.log('Client ID:', CLIENT_ID);
                        console.log('API Key:', API_KEY);
                        
                        await gapi.client.init({
                            apiKey: API_KEY,
                            clientId: CLIENT_ID,
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                            scope: SCOPES
                        });
                        
                        console.log('Google API Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                        
                        // Drive API ÌôúÏÑ±Ìôî ÌôïÏù∏
                        const authInstance = gapi.auth2.getAuthInstance();
                        console.log('Auth Instance ÏÉùÏÑ±Îê®:', authInstance ? 'ÏÑ±Í≥µ' : 'Ïã§Ìå®');
                        
                        resolve();
                    } catch (error) {
                        console.error('Google API Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                        reject(error);
                    }
                });
            });
        }

        async function signIn() {
            try {
                console.log('Î°úÍ∑∏Ïù∏ ÏãúÎèÑ Ï§ë...');
                const authInstance = gapi.auth2.getAuthInstance();
                console.log('Auth Instance:', authInstance);
                
                const user = await authInstance.signIn();
                console.log('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ:', user);
                
                accessToken = user.getAuthResponse().access_token;
                console.log('Access Token ÌöçÎìù:', accessToken ? 'ÏÑ±Í≥µ' : 'Ïã§Ìå®');
                
                return true;
            } catch (error) {
                console.error('Î°úÍ∑∏Ïù∏ Ïã§Ìå® ÏÉÅÏÑ∏:', error);
                console.error('ÏóêÎü¨ ÏΩîÎìú:', error.error);
                console.error('ÏóêÎü¨ ÏÉÅÏÑ∏:', error.details);
                
                alert(`Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\n\nÏóêÎü¨: ${error.error || error.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}\n\nÎ∏åÎùºÏö∞Ï†Ä ÏΩòÏÜî(F12)ÏóêÏÑú ÏÉÅÏÑ∏ ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.`);
                return false;
            }
        }

        // ========================================
        // Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏å ÌååÏùº Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
        // ========================================
        
        async function listDriveFiles() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${FOLDER_ID}' in parents and (mimeType='image/vnd.dxf' or mimeType='application/dxf' or name contains '.dxf')`,
                    fields: 'files(id, name, mimeType)',
                    orderBy: 'modifiedTime desc'
                });
                
                return response.result.files || [];
            } catch (error) {
                console.error('ÌååÏùº Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
                return [];
            }
        }

        // ========================================
        // DXF ÌååÏùº Îã§Ïö¥Î°úÎìú Î∞è ÌååÏã±
        // ========================================
        
        async function downloadDXFFile(fileId) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                return response.body;
            } catch (error) {
                console.error('ÌååÏùº Îã§Ïö¥Î°úÎìú Ïã§Ìå®:', error);
                throw error;
            }
        }

        function parseDXF(dxfString) {
            try {
                // three-dxf ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º ÏÇ¨Ïö©ÌïòÏó¨ ÌååÏã±
                const parser = new window.DxfParser();
                const dxf = parser.parseSync(dxfString);
                return dxf;
            } catch (error) {
                console.error('DXF ÌååÏã± Ïã§Ìå®:', error);
                throw error;
            }
        }

        function renderDXF(dxf) {
            // Í∏∞Ï°¥ DXF Í∞ùÏ≤¥ Ï†úÍ±∞
            scene.children = scene.children.filter(child => 
                child instanceof THREE.Light || child.userData.type === 'annotation'
            );
            
            // DXF Îç∞Ïù¥ÌÑ∞Î•º Three.js Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
            const helper = new window.ThreeDxf.Helper(dxf);
            const entity = helper.toObject();
            
            scene.add(entity);
            
            // Ï†ÑÏ≤¥ Î≥¥Í∏∞Î°ú Ïπ¥Î©îÎùº Ï°∞Ï†ï
            fitToView();
        }

        // ========================================
        // Ï†ÑÏ≤¥ Î≥¥Í∏∞ (Fit to View)
        // ========================================
        
        function fitToView() {
            // SceneÏùò Î∞îÏö¥Îî© Î∞ïÏä§ Í≥ÑÏÇ∞
            const box = new THREE.Box3();
            
            scene.children.forEach(child => {
                if (!(child instanceof THREE.Light)) {
                    box.expandByObject(child);
                }
            });
            
            if (box.isEmpty()) return;
            
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            
            // Ïπ¥Î©îÎùº ÏúÑÏπò Ï°∞Ï†ï
            const container = document.getElementById('canvas-container');
            const aspect = container.clientWidth / container.clientHeight;
            
            const maxSize = Math.max(size.x / aspect, size.y);
            const viewSize = maxSize / 2 * 1.1; // 10% Ïó¨Î∞±
            
            camera.left = -viewSize * aspect;
            camera.right = viewSize * aspect;
            camera.top = viewSize;
            camera.bottom = -viewSize;
            
            camera.position.x = center.x;
            camera.position.y = center.y;
            camera.position.z = 100;
            
            camera.updateProjectionMatrix();
        }

        // ========================================
        // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
        // ========================================
        
        function setupTouchControls() {
            const canvas = document.getElementById('canvas');
            
            // ÌÑ∞Ïπò ÏãúÏûë
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                
                if (e.touches.length === 1) {
                    // Îã®Ïùº ÌÑ∞Ïπò - Î°±ÌîÑÎ†àÏä§ Í∞êÏßÄ ÏãúÏûë
                    const touch = e.touches[0];
                    longPressPosition = { x: touch.clientX, y: touch.clientY };
                    
                    longPressTimer = setTimeout(() => {
                        handleLongPress(longPressPosition);
                    }, 800); // 800ms Î°±ÌîÑÎ†àÏä§
                    
                    previousTouch = { x: touch.clientX, y: touch.clientY };
                    
                } else if (e.touches.length === 2) {
                    // ÌïÄÏπò Ï§å ÏãúÏûë
                    clearTimeout(longPressTimer);
                    isPinching = true;
                    
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    
                    const dx = touch2.clientX - touch1.clientX;
                    const dy = touch2.clientY - touch1.clientY;
                    lastPinchDistance = Math.sqrt(dx * dx + dy * dy);
                }
            });
            
            // ÌÑ∞Ïπò Ïù¥Îèô
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                // Ïù¥ÎèôÌïòÎ©¥ Î°±ÌîÑÎ†àÏä§ Ï∑®ÏÜå
                if (longPressTimer) {
                    const touch = e.touches[0];
                    const dx = touch.clientX - longPressPosition.x;
                    const dy = touch.clientY - longPressPosition.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance > 10) { // 10px Ïù¥ÏÉÅ Ïù¥ÎèôÌïòÎ©¥ Ï∑®ÏÜå
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                }
                
                if (e.touches.length === 1 && previousTouch && !isPinching) {
                    // Ìå®Îãù
                    const touch = e.touches[0];
                    const deltaX = touch.clientX - previousTouch.x;
                    const deltaY = touch.clientY - previousTouch.y;
                    
                    panCamera(deltaX, deltaY);
                    
                    previousTouch = { x: touch.clientX, y: touch.clientY };
                    
                } else if (e.touches.length === 2 && isPinching) {
                    // ÌïÄÏπò Ï§å
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    
                    const dx = touch2.clientX - touch1.clientX;
                    const dy = touch2.clientY - touch1.clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    const delta = distance - lastPinchDistance;
                    zoomCamera(delta * 0.01);
                    
                    lastPinchDistance = distance;
                }
            });
            
            // ÌÑ∞Ïπò Ï¢ÖÎ£å
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                if (e.touches.length === 0) {
                    isDragging = false;
                    isPinching = false;
                    previousTouch = null;
                } else if (e.touches.length === 1) {
                    isPinching = false;
                    previousTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });
        }

        // ========================================
        // Ïπ¥Î©îÎùº Ïù¥Îèô (Pan)
        // ========================================
        
        function panCamera(deltaX, deltaY) {
            const container = document.getElementById('canvas-container');
            const aspect = container.clientWidth / container.clientHeight;
            
            const viewWidth = (camera.right - camera.left);
            const viewHeight = (camera.top - camera.bottom);
            
            const moveX = -(deltaX / container.clientWidth) * viewWidth;
            const moveY = (deltaY / container.clientHeight) * viewHeight;
            
            camera.position.x += moveX;
            camera.position.y += moveY;
        }

        // ========================================
        // Ïπ¥Î©îÎùº Ï§å
        // ========================================
        
        function zoomCamera(delta) {
            const container = document.getElementById('canvas-container');
            const aspect = container.clientWidth / container.clientHeight;
            
            const zoomFactor = 1 - delta;
            
            const viewWidth = (camera.right - camera.left) * zoomFactor;
            const viewHeight = (camera.top - camera.bottom) * zoomFactor;
            
            camera.left = -viewWidth / 2;
            camera.right = viewWidth / 2;
            camera.top = viewHeight / 2;
            camera.bottom = -viewHeight / 2;
            
            camera.updateProjectionMatrix();
        }

        // ========================================
        // Î°±ÌîÑÎ†àÏä§ Ï≤òÎ¶¨
        // ========================================
        
        function handleLongPress(position) {
            if (!dxfData) return;
            
            // ÌÑ∞Ïπò ÏúÑÏπòÎ•º 3D Ï¢åÌëúÎ°ú Î≥ÄÌôò
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            
            const x = ((position.x - rect.left) / rect.width) * 2 - 1;
            const y = -((position.y - rect.top) / rect.height) * 2 + 1;
            
            // Ïπ¥Î©îÎùº Ï¢åÌëúÍ≥ÑÎ°ú Î≥ÄÌôò
            const worldX = camera.position.x + x * (camera.right - camera.left) / 2;
            const worldY = camera.position.y + y * (camera.top - camera.bottom) / 2;
            
            // ÏÇ¨ÏßÑ/ÌÖçÏä§Ìä∏ ÏÑ†ÌÉù Î©îÎâ¥ ÌëúÏãú
            showAnnotationMenu(worldX, worldY);
        }

        // ========================================
        // Ï£ºÏÑù Ï∂îÍ∞Ä Î©îÎâ¥
        // ========================================
        
        let pendingAnnotationPosition = null;

        function showAnnotationMenu(x, y) {
            pendingAnnotationPosition = { x, y };
            
            const choice = confirm('ÏÇ¨ÏßÑÏùÑ Ï∂îÍ∞ÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÌôïÏù∏: ÏÇ¨ÏßÑ\nÏ∑®ÏÜå: ÌÖçÏä§Ìä∏');
            
            if (choice) {
                showPhotoOptions();
            } else {
                showTextModal();
            }
        }

        function showPhotoOptions() {
            const choice = confirm('Ïπ¥Î©îÎùºÎ°ú Ï¥¨ÏòÅÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÌôïÏù∏: Ïπ¥Î©îÎùº\nÏ∑®ÏÜå: Í∞§Îü¨Î¶¨');
            
            if (choice) {
                document.getElementById('photoInput').click();
            } else {
                document.getElementById('galleryInput').click();
            }
        }

        // ========================================
        // ÏÇ¨ÏßÑ Ï≤òÎ¶¨
        // ========================================
        
        function setupPhotoInput() {
            const photoInput = document.getElementById('photoInput');
            const galleryInput = document.getElementById('galleryInput');
            
            photoInput.addEventListener('change', handlePhotoSelect);
            galleryInput.addEventListener('change', handlePhotoSelect);
        }

        async function handlePhotoSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                const imageData = event.target.result;
                
                // Ïù¥ÎØ∏ÏßÄÎ•º Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏åÏóê ÏóÖÎ°úÎìú
                const imageId = await uploadImageToDrive(file);
                
                if (imageId && pendingAnnotationPosition) {
                    // Ï£ºÏÑù Ï∂îÍ∞Ä
                    const annotation = {
                        type: 'photo',
                        position: pendingAnnotationPosition,
                        imageId: imageId,
                        imageName: file.name,
                        timestamp: new Date().toISOString()
                    };
                    
                    annotations.push(annotation);
                    updateAnnotationMarkers();
                    
                    // ÏûêÎèô Ï†ÄÏû•
                    await saveAnnotations();
                    
                    pendingAnnotationPosition = null;
                }
            };
            reader.readAsDataURL(file);
            
            // ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
            e.target.value = '';
        }

        // ========================================
        // ÌÖçÏä§Ìä∏ Î™®Îã¨
        // ========================================
        
        function showTextModal() {
            document.getElementById('textModal').classList.add('active');
            document.getElementById('textInput').value = '';
            document.getElementById('textInput').focus();
        }

        function setupTextModal() {
            const textModal = document.getElementById('textModal');
            const textInput = document.getElementById('textInput');
            const confirmBtn = document.getElementById('confirmText');
            const cancelBtn = document.getElementById('cancelText');
            
            confirmBtn.addEventListener('click', async () => {
                const text = textInput.value.trim();
                if (text && pendingAnnotationPosition) {
                    const annotation = {
                        type: 'text',
                        position: pendingAnnotationPosition,
                        text: text,
                        timestamp: new Date().toISOString()
                    };
                    
                    annotations.push(annotation);
                    updateAnnotationMarkers();
                    
                    // ÏûêÎèô Ï†ÄÏû•
                    await saveAnnotations();
                    
                    pendingAnnotationPosition = null;
                }
                
                textModal.classList.remove('active');
            });
            
            cancelBtn.addEventListener('click', () => {
                textModal.classList.remove('active');
                pendingAnnotationPosition = null;
            });
        }

        // ========================================
        // Ï£ºÏÑù ÎßàÏª§ ÏóÖÎç∞Ïù¥Ìä∏
        // ========================================
        
        function updateAnnotationMarkers() {
            // Í∏∞Ï°¥ ÎßàÏª§ Ï†úÍ±∞
            document.querySelectorAll('.annotation-marker').forEach(el => el.remove());
            
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            
            annotations.forEach((annotation, index) => {
                // 3D Ï¢åÌëúÎ•º ÌôîÎ©¥ Ï¢åÌëúÎ°ú Î≥ÄÌôò
                const screenPos = worldToScreen(annotation.position.x, annotation.position.y);
                
                const marker = document.createElement('div');
                marker.className = `annotation-marker ${annotation.type}-marker`;
                marker.innerHTML = annotation.type === 'photo' ? 'üì∑' : 'üìù';
                marker.style.left = `${screenPos.x - 15}px`;
                marker.style.top = `${screenPos.y - 15}px`;
                marker.dataset.index = index;
                
                // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ - Ï£ºÏÑù Î≥¥Í∏∞
                marker.addEventListener('click', () => {
                    showAnnotationDetail(annotation);
                });
                
                container.appendChild(marker);
            });
        }

        // ========================================
        // 3D Ï¢åÌëúÎ•º ÌôîÎ©¥ Ï¢åÌëúÎ°ú Î≥ÄÌôò
        // ========================================
        
        function worldToScreen(worldX, worldY) {
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            
            const viewWidth = camera.right - camera.left;
            const viewHeight = camera.top - camera.bottom;
            
            const normalizedX = (worldX - camera.position.x) / (viewWidth / 2);
            const normalizedY = (worldY - camera.position.y) / (viewHeight / 2);
            
            const screenX = (normalizedX + 1) / 2 * rect.width;
            const screenY = (1 - normalizedY) / 2 * rect.height;
            
            return { x: screenX, y: screenY };
        }

        // ========================================
        // Ï£ºÏÑù ÏÉÅÏÑ∏Î≥¥Í∏∞
        // ========================================
        
        function showAnnotationDetail(annotation) {
            if (annotation.type === 'photo') {
                alert(`ÏÇ¨ÏßÑ: ${annotation.imageName}\nÎÇ†Ïßú: ${new Date(annotation.timestamp).toLocaleString('ko-KR')}`);
            } else {
                alert(`ÌÖçÏä§Ìä∏: ${annotation.text}\nÎÇ†Ïßú: ${new Date(annotation.timestamp).toLocaleString('ko-KR')}`);
            }
        }

        // ========================================
        // Íµ¨Í∏Ä ÎìúÎùºÏù¥Î∏åÏóê Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
        // ========================================
        
        async function uploadImageToDrive(file) {
            try {
                const metadata = {
                    name: `${currentFileName}_${Date.now()}_${file.name}`,
                    parents: [FOLDER_ID]
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
                
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: form
                });
                
                const result = await response.json();
                return result.id;
            } catch (error) {
                console.error('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®:', error);
                alert('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                return null;
            }
        }

        // ========================================
        // Ï£ºÏÑù Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        // ========================================
        
        async function saveAnnotations() {
            if (!currentFileId || annotations.length === 0) return;
            
            showSpinner(true);
            
            try {
                const metadata = {
                    dxfFileId: currentFileId,
                    dxfFileName: currentFileName,
                    annotations: annotations,
                    savedAt: new Date().toISOString()
                };
                
                const metadataFileName = `${currentFileName}_metadata.json`;
                
                // Í∏∞Ï°¥ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÌååÏùº Í≤ÄÏÉâ
                const existingFiles = await gapi.client.drive.files.list({
                    q: `name='${metadataFileName}' and '${FOLDER_ID}' in parents`,
                    fields: 'files(id)'
                });
                
                const metadataBlob = new Blob([JSON.stringify(metadata, null, 2)], { type: 'application/json' });
                
                if (existingFiles.result.files.length > 0) {
                    // Í∏∞Ï°¥ ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏
                    const fileId = existingFiles.result.files[0].id;
                    
                    const form = new FormData();
                    form.append('file', metadataBlob);
                    
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: metadataBlob
                    });
                } else {
                    // ÏÉà ÌååÏùº ÏÉùÏÑ±
                    const fileMetadata = {
                        name: metadataFileName,
                        parents: [FOLDER_ID]
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
                    form.append('file', metadataBlob);
                    
                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: form
                    });
                }
                
                console.log('Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å');
            } catch (error) {
                console.error('Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            } finally {
                showSpinner(false);
            }
        }

        // ========================================
        // Í∏∞Ï°¥ Ï£ºÏÑù Î°úÎìú
        // ========================================
        
        async function loadAnnotations() {
            if (!currentFileId) return;
            
            try {
                const metadataFileName = `${currentFileName}_metadata.json`;
                
                const response = await gapi.client.drive.files.list({
                    q: `name='${metadataFileName}' and '${FOLDER_ID}' in parents`,
                    fields: 'files(id)'
                });
                
                if (response.result.files.length > 0) {
                    const fileId = response.result.files[0].id;
                    
                    const metadataResponse = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });
                    
                    const metadata = JSON.parse(metadataResponse.body);
                    annotations = metadata.annotations || [];
                    
                    updateAnnotationMarkers();
                    console.log('Ï£ºÏÑù Î°úÎìú ÏôÑÎ£å:', annotations.length);
                }
            } catch (error) {
                console.error('Ï£ºÏÑù Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        // ========================================
        // ÌååÏùº Ïó¥Í∏∞ Î≤ÑÌäº
        // ========================================
        
        async function openFile() {
            // Î°úÍ∑∏Ïù∏ ÌôïÏù∏
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                
                if (!authInstance) {
                    alert('Google APIÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.\nÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                    console.error('authInstance is null');
                    return;
                }
                
                console.log('ÌòÑÏû¨ Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú:', authInstance.isSignedIn.get());
                
                if (!authInstance.isSignedIn.get()) {
                    const success = await signIn();
                    if (!success) return;
                }
            } catch (error) {
                console.error('ÌååÏùº Ïó¥Í∏∞ Ïò§Î•ò:', error);
                alert(`Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`);
                return;
            }
            
            showSpinner(true);
            
            // ÌååÏùº Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
            const files = await listDriveFiles();
            
            showSpinner(false);
            
            if (files.length === 0) {
                alert('DXF ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // ÌååÏùº ÏÑ†ÌÉù Î™®Îã¨ ÌëúÏãú
            showFileModal(files);
        }

        function showFileModal(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.textContent = file.name;
                item.addEventListener('click', () => {
                    loadDXFFile(file.id, file.name);
                    document.getElementById('fileModal').classList.remove('active');
                });
                fileList.appendChild(item);
            });
            
            document.getElementById('fileModal').classList.add('active');
        }

        // ========================================
        // DXF ÌååÏùº Î°úÎìú Î∞è Î†åÎçîÎßÅ
        // ========================================
        
        async function loadDXFFile(fileId, fileName) {
            showSpinner(true);
            
            try {
                // DXF ÌååÏùº Îã§Ïö¥Î°úÎìú
                const dxfString = await downloadDXFFile(fileId);
                
                // DXF ÌååÏã±
                dxfData = parseDXF(dxfString);
                
                // Î†åÎçîÎßÅ
                renderDXF(dxfData);
                
                // ÌòÑÏû¨ ÌååÏùº Ï†ïÎ≥¥ Ï†ÄÏû•
                currentFileId = fileId;
                currentFileName = fileName.replace('.dxf', '');
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('filename').textContent = fileName;
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('photoBtn').disabled = false;
                document.getElementById('textBtn').disabled = false;
                document.getElementById('fitBtn').disabled = false;
                
                // Í∏∞Ï°¥ Ï£ºÏÑù Î°úÎìú
                annotations = [];
                await loadAnnotations();
                
            } catch (error) {
                console.error('ÌååÏùº Î°úÎìú Ïã§Ìå®:', error);
                alert('ÌååÏùºÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            } finally {
                showSpinner(false);
            }
        }

        // ========================================
        // Ïä§ÌîºÎÑà ÌëúÏãú/Ïà®ÍπÄ
        // ========================================
        
        function showSpinner(show) {
            const spinner = document.getElementById('spinner');
            if (show) {
                spinner.classList.add('active');
            } else {
                spinner.classList.remove('active');
            }
        }

        // ========================================
        // Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        // ========================================
        
        function setupButtonListeners() {
            // Ïó¥Í∏∞ Î≤ÑÌäº
            document.getElementById('openBtn').addEventListener('click', openFile);
            
            // Ï†ÄÏû• Î≤ÑÌäº
            document.getElementById('saveBtn').addEventListener('click', async () => {
                await saveAnnotations();
                alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
            });
            
            // ÏÇ¨ÏßÑ Î≤ÑÌäº (Ìà¥Î∞î)
            document.getElementById('photoBtn').addEventListener('click', () => {
                alert('ÎèÑÎ©¥ÏùÑ Í∏∏Í≤å ÎàÑÎ•¥Í≥† ÏûàÏúºÎ©¥ ÏÇ¨ÏßÑÏù¥ÎÇò ÌÖçÏä§Ìä∏Î•º Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.');
            });
            
            // ÌÖçÏä§Ìä∏ Î≤ÑÌäº (Ìà¥Î∞î)
            document.getElementById('textBtn').addEventListener('click', () => {
                alert('ÎèÑÎ©¥ÏùÑ Í∏∏Í≤å ÎàÑÎ•¥Í≥† ÏûàÏúºÎ©¥ ÏÇ¨ÏßÑÏù¥ÎÇò ÌÖçÏä§Ìä∏Î•º Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.');
            });
            
            // Ï†ÑÏ≤¥Î≥¥Í∏∞ Î≤ÑÌäº
            document.getElementById('fitBtn').addEventListener('click', fitToView);
            
            // ÌååÏùº Î™®Îã¨ Îã´Í∏∞
            document.getElementById('closeFileModal').addEventListener('click', () => {
                document.getElementById('fileModal').classList.remove('active');
            });
        }

        // ========================================
        // Ï¥àÍ∏∞Ìôî Î∞è ÏãúÏûë
        // ========================================
        
        async function init() {
            console.log('Ïï± Ï¥àÍ∏∞Ìôî ÏãúÏûë...');
            
            // Three.js Ï¥àÍ∏∞Ìôî
            initThreeJS();
            
            // ÌÑ∞Ïπò Ïª®Ìä∏Î°§ ÏÑ§Ï†ï
            setupTouchControls();
            
            // Î≤ÑÌäº Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupButtonListeners();
            
            // ÏÇ¨ÏßÑ ÏûÖÎ†• ÏÑ§Ï†ï
            setupPhotoInput();
            
            // ÌÖçÏä§Ìä∏ Î™®Îã¨ ÏÑ§Ï†ï
            setupTextModal();
            
            // Google API Ï¥àÍ∏∞Ìôî
            await loadGoogleAPI();
            
            console.log('Ïï± Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        }

        // ========================================
        // Google API Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú
        // ========================================
        
        function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                // Ïù¥ÎØ∏ Î°úÎìúÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                if (window.gapi) {
                    console.log('Google API Ïù¥ÎØ∏ Î°úÎìúÎê®');
                    initGoogleAPI().then(resolve).catch(reject);
                    return;
                }
                
                console.log('Google API Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú Ï§ë...');
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.async = true;
                script.defer = true;
                
                script.onload = async () => {
                    console.log('Google API Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú ÏôÑÎ£å');
                    try {
                        await initGoogleAPI();
                        resolve();
                    } catch (error) {
                        console.error('Google API Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•ò:', error);
                        reject(error);
                    }
                };
                
                script.onerror = (error) => {
                    console.error('Google API Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú Ïã§Ìå®:', error);
                    reject(new Error('Google API Ïä§ÌÅ¨Î¶ΩÌä∏Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.'));
                };
                
                document.head.appendChild(script);
            });
        }

        // Ïï± ÏãúÏûë
        window.addEventListener('load', init);

        // Ïπ¥Î©îÎùº Ïù¥ÎèôÏãú ÎßàÏª§ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
        setInterval(() => {
            if (annotations.length > 0 && dxfData) {
                updateAnnotationMarkers();
            }
        }, 100); // 100msÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DMAP - SVG ë²„ì „ (ê²½ëŸ‰)</title>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" class="overlay">
        <div class="spinner"></div>
        <p>ë¡œë”© ì¤‘...</p>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
            SVG ë°©ì‹ - ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆí•„ìš”
        </p>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="app" class="hidden">
        <!-- í—¤ë” -->
        <header>
            <div class="header-left">
                <button id="backBtn" class="icon-btn hidden">
                    <span>â—€</span>
                </button>
                <h1 id="appTitle">DMAP (SVG)</h1>
            </div>
            <div class="header-right">
                <button id="userBtn" class="icon-btn">
                    <span id="userIcon">ğŸ‘¤</span>
                </button>
            </div>
        </header>

        <!-- íŒŒì¼ ëª©ë¡ í™”ë©´ -->
        <div id="fileListScreen" class="screen">
            <div class="screen-header">
                <h2>ğŸ“ DXF ë„ë©´ ëª©ë¡</h2>
                <button id="refreshBtn" class="btn-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div class="info-box" style="margin: 16px; padding: 12px; background: #fff3cd; border-radius: 6px;">
                <strong>â„¹ï¸ SVG ê²½ëŸ‰ ë²„ì „</strong><br>
                ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ìˆœìˆ˜ JavaScriptë¡œ ì‘ë™í•©ë‹ˆë‹¤.<br>
                LINE, CIRCLE, ARC ì§€ì›
            </div>
            <div id="fileList" class="file-list">
                <p class="loading-text">íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <!-- DXF ë·°ì–´ í™”ë©´ -->
        <div id="viewerScreen" class="screen hidden">
            <!-- ë„êµ¬ ëª¨ìŒ -->
            <div id="toolbar" class="toolbar">
                <button id="fitViewBtn" class="tool-btn" title="ì „ì²´ë³´ê¸°">
                    <span>ğŸ”²</span>
                </button>
                <button id="addPhotoBtn" class="tool-btn" title="ì‚¬ì§„ ì¶”ê°€">
                    <span>ğŸ“·</span>
                </button>
                <button id="addTextBtn" class="tool-btn" title="í…ìŠ¤íŠ¸ ì¶”ê°€">
                    <span>ğŸ“</span>
                </button>
                <button id="saveBtn" class="tool-btn primary" title="ì €ì¥">
                    <span>ğŸ’¾</span>
                </button>
            </div>

            <!-- SVG ë·°ì–´ ì»¨í…Œì´ë„ˆ -->
            <div id="viewerContainer">
                <!-- SVGê°€ ì—¬ê¸°ì— ì‚½ì…ë¨ -->
                <div id="annotationLayer"></div>
            </div>

            <!-- ë¡±í”„ë ˆìŠ¤ ë©”ë‰´ -->
            <div id="contextMenu" class="context-menu hidden">
                <button id="menuPhotoBtn" class="menu-item">
                    ğŸ“· ì‚¬ì§„ ì¶”ê°€
                </button>
                <button id="menuTextBtn" class="menu-item">
                    ğŸ“ í…ìŠ¤íŠ¸ ì¶”ê°€
                </button>
                <button id="menuCancelBtn" class="menu-item cancel">
                    âŒ ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>

    <!-- ì‚¬ì§„/í…ìŠ¤íŠ¸ ëª¨ë‹¬ (ë™ì¼) -->
    <div id="photoModal" class="modal hidden">
        <div class="modal-content">
            <h3>ì‚¬ì§„ ì¶”ê°€</h3>
            <div class="photo-options">
                <button id="takePictureBtn" class="btn-primary">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜</button>
                <button id="selectPictureBtn" class="btn-primary">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ</button>
            </div>
            <div id="photoPreview" class="photo-preview hidden">
                <img id="previewImage" alt="ë¯¸ë¦¬ë³´ê¸°">
                <textarea id="photoMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
                <div class="modal-actions">
                    <button id="confirmPhotoBtn" class="btn-primary">í™•ì¸</button>
                    <button id="cancelPhotoBtn" class="btn-secondary">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="textModal" class="modal hidden">
        <div class="modal-content">
            <h3>í…ìŠ¤íŠ¸ ì¶”ê°€</h3>
            <textarea id="textInput" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="4"></textarea>
            <div class="modal-actions">
                <button id="confirmTextBtn" class="btn-primary">í™•ì¸</button>
                <button id="cancelTextBtn" class="btn-secondary">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="imageViewerModal" class="modal hidden">
        <div class="modal-content image-viewer">
            <button id="closeImageBtn" class="close-btn">âœ•</button>
            <img id="fullImage" alt="ì „ì²´ ì´ë¯¸ì§€">
            <p id="imageMemo" class="image-memo"></p>
        </div>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
    <input type="file" id="galleryInput" accept="image/*" style="display:none">

    <!-- Google Identity Servicesë§Œ í•„ìš” -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- SVG ë²„ì „ ì•± ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import GoogleDriveManager from './google-drive.js';
        import DxfSvgViewer from './dxf-svg-viewer.js';
        import AnnotationManager from './photo-manager.js';

        // SVG ë²„ì „ ì•± (Three.js ë¶ˆí•„ìš”)
        class DmapSvgApp {
            constructor() {
                this.driveManager = new GoogleDriveManager();
                this.viewer = null;
                this.annotationManager = null;
                this.currentFile = null;
                this.longPressTimer = null;
                this.longPressPosition = null;
                
                this.initialize();
            }

            async initialize() {
                try {
                    console.log('ğŸ¨ SVG ë²„ì „ ì•± ì´ˆê¸°í™”...');
                    
                    // Google Drive APIë§Œ ëŒ€ê¸°
                    await this.driveManager.initialize();

                    document.getElementById('loadingOverlay').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');

                    this.setupEventListeners();
                    await this.checkAuthentication();

                    console.log('âœ… SVG ë²„ì „ ì´ˆê¸°í™” ì™„ë£Œ');
                } catch (error) {
                    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    alert('ì•± ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }

            async checkAuthentication() {
                if (!this.driveManager.accessToken) {
                    await this.showLoginPrompt();
                } else {
                    await this.loadFileList();
                }
            }

            async showLoginPrompt() {
                if (confirm('Google Driveì— ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    try {
                        await this.driveManager.authenticate();
                        await this.loadFileList();
                    } catch (error) {
                        console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                        alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            }

            async loadFileList() {
                try {
                    const files = await this.driveManager.listDxfFiles();
                    this.renderFileList(files);
                } catch (error) {
                    console.error('íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                }
            }

            renderFileList(files) {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';

                if (files.length === 0) {
                    fileList.innerHTML = '<p class="loading-text">DXF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                files.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'file-item';
                    item.innerHTML = `
                        <div class="file-icon">ğŸ“„</div>
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-date">${new Date(file.modifiedTime).toLocaleString('ko-KR')}</div>
                        </div>
                    `;
                    item.addEventListener('click', () => this.openFile(file));
                    fileList.appendChild(item);
                });
            }

            async openFile(file) {
                try {
                    const dxfContent = await this.driveManager.downloadFile(file.id);

                    // SVG ë·°ì–´ ì´ˆê¸°í™”
                    if (!this.viewer) {
                        const container = document.getElementById('viewerContainer');
                        const annotationLayer = document.getElementById('annotationLayer');
                        this.viewer = new DxfSvgViewer(container);
                        this.annotationManager = new AnnotationManager(
                            this.viewer,
                            annotationLayer,
                            this.driveManager
                        );
                    }

                    await this.viewer.loadDxf(dxfContent);
                    this.annotationManager.setDxfFile(file.name);
                    await this.annotationManager.loadAnnotations();

                    this.currentFile = file;
                    this.showViewerScreen();
                } catch (error) {
                    console.error('íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨:', error);
                    alert('íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
                }
            }

            showViewerScreen() {
                document.getElementById('fileListScreen').classList.add('hidden');
                document.getElementById('viewerScreen').classList.remove('hidden');
                document.getElementById('backBtn').classList.remove('hidden');
                document.getElementById('appTitle').textContent = this.currentFile?.name || 'DMAP';
            }

            showFileListScreen() {
                document.getElementById('viewerScreen').classList.add('hidden');
                document.getElementById('fileListScreen').classList.remove('hidden');
                document.getElementById('backBtn').classList.add('hidden');
                document.getElementById('appTitle').textContent = 'DMAP (SVG)';
            }

            setupEventListeners() {
                document.getElementById('backBtn').addEventListener('click', () => this.showFileListScreen());
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadFileList());
                document.getElementById('fitViewBtn').addEventListener('click', () => {
                    if (this.viewer) this.viewer.fitToView();
                });
                
                // ë‚˜ë¨¸ì§€ ì´ë²¤íŠ¸ëŠ” app.jsì™€ ë™ì¼...
            }
        }

        // ì•± ì‹œì‘
        window.addEventListener('DOMContentLoaded', () => {
            new DmapSvgApp();
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DMAP - ë„ë©´ ë·°ì–´ (ë°±ì—…)</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- íŒŒë¹„ì½˜ -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" class="overlay">
        <div class="spinner"></div>
        <p>ë¡œë”© ì¤‘...</p>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
            ëŒ€ì²´ CDN ì‚¬ìš© ì¤‘...
        </p>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="app" class="hidden">
        <!-- í—¤ë” -->
        <header>
            <div class="header-left">
                <button id="backBtn" class="icon-btn hidden">
                    <span>â—€</span>
                </button>
                <h1 id="appTitle">DMAP</h1>
            </div>
            <div class="header-right">
                <button id="userBtn" class="icon-btn">
                    <span id="userIcon">ğŸ‘¤</span>
                </button>
            </div>
        </header>

        <!-- íŒŒì¼ ëª©ë¡ í™”ë©´ -->
        <div id="fileListScreen" class="screen">
            <div class="screen-header">
                <h2>ğŸ“ DXF ë„ë©´ ëª©ë¡</h2>
                <button id="refreshBtn" class="btn-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="fileList" class="file-list">
                <p class="loading-text">íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <!-- DXF ë·°ì–´ í™”ë©´ -->
        <div id="viewerScreen" class="screen hidden">
            <!-- ë„êµ¬ ëª¨ìŒ -->
            <div id="toolbar" class="toolbar">
                <button id="fitViewBtn" class="tool-btn" title="ì „ì²´ë³´ê¸°">
                    <span>ğŸ”²</span>
                </button>
                <button id="addPhotoBtn" class="tool-btn" title="ì‚¬ì§„ ì¶”ê°€">
                    <span>ğŸ“·</span>
                </button>
                <button id="addTextBtn" class="tool-btn" title="í…ìŠ¤íŠ¸ ì¶”ê°€">
                    <span>ğŸ“</span>
                </button>
                <button id="saveBtn" class="tool-btn primary" title="ì €ì¥">
                    <span>ğŸ’¾</span>
                </button>
            </div>

            <!-- DXF ë·°ì–´ ìº”ë²„ìŠ¤ -->
            <div id="viewerContainer">
                <canvas id="viewerCanvas"></canvas>
                <!-- ì–´ë…¸í…Œì´ì…˜ ì˜¤ë²„ë ˆì´ (ì‚¬ì§„ ì´ëª¨ì§€, í…ìŠ¤íŠ¸ í‘œì‹œ) -->
                <div id="annotationLayer"></div>
            </div>

            <!-- ë¡±í”„ë ˆìŠ¤ ë©”ë‰´ -->
            <div id="contextMenu" class="context-menu hidden">
                <button id="menuPhotoBtn" class="menu-item">
                    ğŸ“· ì‚¬ì§„ ì¶”ê°€
                </button>
                <button id="menuTextBtn" class="menu-item">
                    ğŸ“ í…ìŠ¤íŠ¸ ì¶”ê°€
                </button>
                <button id="menuCancelBtn" class="menu-item cancel">
                    âŒ ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>

    <!-- ì‚¬ì§„ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="photoModal" class="modal hidden">
        <div class="modal-content">
            <h3>ì‚¬ì§„ ì¶”ê°€</h3>
            <div class="photo-options">
                <button id="takePictureBtn" class="btn-primary">
                    ğŸ“¸ ì‚¬ì§„ ì´¬ì˜
                </button>
                <button id="selectPictureBtn" class="btn-primary">
                    ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ
                </button>
            </div>
            <div id="photoPreview" class="photo-preview hidden">
                <img id="previewImage" alt="ë¯¸ë¦¬ë³´ê¸°">
                <textarea id="photoMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
                <div class="modal-actions">
                    <button id="confirmPhotoBtn" class="btn-primary">í™•ì¸</button>
                    <button id="cancelPhotoBtn" class="btn-secondary">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- í…ìŠ¤íŠ¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="textModal" class="modal hidden">
        <div class="modal-content">
            <h3>í…ìŠ¤íŠ¸ ì¶”ê°€</h3>
            <textarea id="textInput" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="4"></textarea>
            <div class="modal-actions">
                <button id="confirmTextBtn" class="btn-primary">í™•ì¸</button>
                <button id="cancelTextBtn" class="btn-secondary">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ ë·°ì–´ ëª¨ë‹¬ -->
    <div id="imageViewerModal" class="modal hidden">
        <div class="modal-content image-viewer">
            <button id="closeImageBtn" class="close-btn">âœ•</button>
            <img id="fullImage" alt="ì „ì²´ ì´ë¯¸ì§€">
            <p id="imageMemo" class="image-memo"></p>
        </div>
    </div>

    <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
    <input type="file" id="galleryInput" accept="image/*" style="display:none">

    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì—¬ëŸ¬ CDN ëŒ€ì²´) -->
    <script>
        // Three.js ë¡œë”© (ì—¬ëŸ¬ CDN ì‹œë„)
        (function() {
            const cdns = [
                'https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js',
                'https://unpkg.com/three@0.150.1/build/three.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/three.js/r150/three.min.js'
            ];
            
            let index = 0;
            
            function loadThree() {
                if (index >= cdns.length) {
                    console.error('âŒ Three.jsë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdns[index];
                script.onload = () => {
                    console.log('âœ… Three.js ë¡œë“œ ì™„ë£Œ:', cdns[index]);
                    loadDxfParser();
                };
                script.onerror = () => {
                    console.warn('âš ï¸ Three.js ë¡œë“œ ì‹¤íŒ¨:', cdns[index]);
                    index++;
                    loadThree();
                };
                document.head.appendChild(script);
            }
            
            function loadDxfParser() {
                const cdns = [
                    'https://unpkg.com/dxf-parser@1.5.0/dist/dxf-parser.min.js',
                    'https://cdn.jsdelivr.net/npm/dxf-parser@1.5.0/dist/dxf-parser.min.js'
                ];
                
                let index = 0;
                
                function tryLoad() {
                    if (index >= cdns.length) {
                        console.error('âŒ DxfParserë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdns[index];
                    script.onload = () => {
                        console.log('âœ… DxfParser ë¡œë“œ ì™„ë£Œ:', cdns[index]);
                        loadApp();
                    };
                    script.onerror = () => {
                        console.warn('âš ï¸ DxfParser ë¡œë“œ ì‹¤íŒ¨:', cdns[index]);
                        index++;
                        tryLoad();
                    };
                    document.head.appendChild(script);
                }
                
                tryLoad();
            }
            
            function loadApp() {
                // Google Identity Services
                const gis = document.createElement('script');
                gis.src = 'https://accounts.google.com/gsi/client';
                gis.async = true;
                gis.defer = true;
                document.head.appendChild(gis);
                
                // ì•± ìŠ¤í¬ë¦½íŠ¸
                const app = document.createElement('script');
                app.type = 'module';
                app.src = 'app.js';
                document.head.appendChild(app);
            }
            
            loadThree();
        })();
    </script>
</body>
</html>


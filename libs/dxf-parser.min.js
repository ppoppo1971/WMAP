// 간단한 DXF 파서 (기본 기능)
(function(global) {
    'use strict';
    
    function DxfParser() {}
    
    DxfParser.prototype.parseSync = function(dxfString) {
        try {
            var lines = dxfString.split(/\r?\n/);
            var entities = [];
            var inEntitiesSection = false;
            var currentEntity = null;
            var i = 0;
            
            while (i < lines.length) {
                var line = lines[i].trim();
                
                if (line === 'SECTION') {
                    i++;
                    if (lines[i] && lines[i].trim() === '2') {
                        i++;
                        if (lines[i] && lines[i].trim() === 'ENTITIES') {
                            inEntitiesSection = true;
                        }
                    }
                }
                
                if (inEntitiesSection && line === '0') {
                    i++;
                    var entityType = lines[i] ? lines[i].trim() : '';
                    
                    if (entityType === 'ENDSEC') {
                        inEntitiesSection = false;
                        i++;
                        continue;
                    }
                    
                    if (currentEntity) {
                        entities.push(currentEntity);
                    }
                    
                    currentEntity = {
                        type: entityType,
                        layer: '0'
                    };
                }
                
                if (currentEntity && inEntitiesSection) {
                    var code = parseInt(line);
                    i++;
                    var value = lines[i] ? lines[i].trim() : '';
                    
                    // LINE
                    if (currentEntity.type === 'LINE') {
                        if (code === 10) {
                            currentEntity.startPoint = currentEntity.startPoint || {};
                            currentEntity.startPoint.x = parseFloat(value);
                        } else if (code === 20) {
                            currentEntity.startPoint = currentEntity.startPoint || {};
                            currentEntity.startPoint.y = parseFloat(value);
                        } else if (code === 11) {
                            currentEntity.endPoint = currentEntity.endPoint || {};
                            currentEntity.endPoint.x = parseFloat(value);
                        } else if (code === 21) {
                            currentEntity.endPoint = currentEntity.endPoint || {};
                            currentEntity.endPoint.y = parseFloat(value);
                        }
                    }
                    
                    // CIRCLE
                    if (currentEntity.type === 'CIRCLE') {
                        if (code === 10) {
                            currentEntity.center = currentEntity.center || {};
                            currentEntity.center.x = parseFloat(value);
                        } else if (code === 20) {
                            currentEntity.center = currentEntity.center || {};
                            currentEntity.center.y = parseFloat(value);
                        } else if (code === 40) {
                            currentEntity.radius = parseFloat(value);
                        }
                    }
                    
                    // ARC
                    if (currentEntity.type === 'ARC') {
                        if (code === 10) {
                            currentEntity.center = currentEntity.center || {};
                            currentEntity.center.x = parseFloat(value);
                        } else if (code === 20) {
                            currentEntity.center = currentEntity.center || {};
                            currentEntity.center.y = parseFloat(value);
                        } else if (code === 40) {
                            currentEntity.radius = parseFloat(value);
                        } else if (code === 50) {
                            currentEntity.startAngle = parseFloat(value);
                        } else if (code === 51) {
                            currentEntity.endAngle = parseFloat(value);
                        }
                    }
                    
                    // LWPOLYLINE 시작
                    if (currentEntity.type === 'LWPOLYLINE' && code === 90) {
                        currentEntity.vertices = [];
                        currentEntity.vertexCount = parseInt(value);
                        currentEntity.currentVertex = {};
                    }
                    
                    // LWPOLYLINE 좌표
                    if (currentEntity.type === 'LWPOLYLINE') {
                        if (code === 10) {
                            if (currentEntity.currentVertex && (currentEntity.currentVertex.x !== undefined || currentEntity.currentVertex.y !== undefined)) {
                                currentEntity.vertices.push({...currentEntity.currentVertex});
                                currentEntity.currentVertex = {};
                            }
                            currentEntity.currentVertex.x = parseFloat(value);
                        } else if (code === 20) {
                            currentEntity.currentVertex.y = parseFloat(value);
                            if (currentEntity.currentVertex.x !== undefined) {
                                currentEntity.vertices.push({...currentEntity.currentVertex});
                                currentEntity.currentVertex = {};
                            }
                        }
                    }
                }
                
                i++;
            }
            
            if (currentEntity) {
                entities.push(currentEntity);
            }
            
            console.log('✅ DXF 파싱 완료:', entities.length, '개 엔티티');
            
            return {
                entities: entities
            };
            
        } catch (error) {
            console.error('❌ DXF 파싱 오류:', error);
            throw error;
        }
    };
    
    // Export
    if (typeof module !== 'undefined' && module.exports) {
        module.exports = DxfParser;
    } else {
        global.DxfParser = DxfParser;
    }
    
})(typeof window !== 'undefined' ? window : this);

console.log('✅ DxfParser 로드됨 (간단 버전)');

